# B4 â€” Full Proposal: SSL + BPEH + LCD
#
# Ablation variant: all research contributions combined.
# SSL: scene state latent for cross-turn consistency
# BPEH: breath-pause event prediction
# LCD: latency-conditioned distillation with quality/latency monotonicity
#
# Usage:
#   uv run tmrvc-distill --config configs/research/b4.yaml --cache-dir data/cache \
#     --teacher-ckpt checkpoints/teacher_best.pt --phase LCD --device xpu

variant: b4
description: "Full proposal: SSL + BPEH + LCD (Latency-Conditioned Distillation)."

# --- Model ---
model:
  type: teacher_unet
  d_content: 768
  d_speaker: 192
  n_acoustic_params: 32
  ssl_enabled: true
  bpeh_enabled: true
  lcd_enabled: true

# --- SSL ---
ssl:
  d_scene_state: 64
  d_history: 128
  n_gru_layers: 1
  prosody_stats_dim: 8
  state_reset_policy: scene_boundary

# --- BPEH ---
bpeh:
  d_hidden: 128
  n_blocks: 3
  breath_threshold_db: -40.0
  min_pause_ms: 50.0
  min_breath_ms: 80.0

# --- LCD ---
lcd:
  q_sampling: uniform   # q ~ U[0,1] per batch
  mono_margin: 0.05
  latency_budget:
    hq_mode_ms: 80
    live_mode_ms: 20

# --- Training ---
training:
  batch_size: 64
  max_frames: 400
  lr: 5.0e-5
  warmup_steps: 2000
  max_steps: 150000
  grad_clip: 1.0

# --- Loss weights ---
loss_weights:
  lambda_duration: 1.0
  lambda_f0: 0.5
  lambda_content: 1.0
  lambda_voiced: 0.2
  # SSL
  lambda_state_recon: 0.5
  lambda_state_cons: 0.3
  # BPEH
  lambda_onset: 0.5
  lambda_dur: 0.3
  lambda_amp: 0.2
  # LCD
  lambda_latency: 0.2
  lambda_mono: 0.2

# --- Sampling ---
sampling:
  steps: 32
  sway_coefficient: 1.0
  cfg_scale: 1.0

# --- Test split (same as B0-B3) ---
test_split:
  datasets: [vctk, jvs]
  speakers:
    - vctk_p225
    - vctk_p226
    - vctk_p227
    - vctk_p228
    - jvs_jvs001
    - jvs_jvs002
    - jvs_jvs003
    - jvs_jvs004
  max_utterances_per_speaker: 10

# --- Metrics ---
metrics:
  - mel_mse
  - secs
  - f0_correlation
  - utmos_proxy
  - breath_event_f1
  - turn_coherence_score
  - latency_p50
  - latency_p95
  - monotonicity_pass_rate

# --- Output ---
output:
  format: json
  save_mel: false
  save_audio: true
